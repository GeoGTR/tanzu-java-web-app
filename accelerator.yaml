accelerator:
  displayName: Tanzu Java Web App
  description: A sample Spring Boot web application built with Tanzu supply-chain
  iconUrl: https://github.com/sample-accelerators/icons/raw/master/icon-boot.png
  tags:
  - java
  - spring
  - web
  - tanzu

  options:
  # - name: repositoryPrefix
  #   inputType: text
  #   label: Prefix for the container image repository
  #   defaultValue: dev.local
  #   required: true
  - name: instances
    label: Minimum number of instances to start
    inputType: select
    display: true
    defaultValue: "1"
    choices:
      - text: "Scale To 0"
        value: "0"
      - text: "1 instance"
        value: "1"
      - text: "2 instances"
        value: "2"
  - label: Create Custom Logging Pattern
    description: "If selected, you can override the default logging pattern with you own custom pattern."
    defaultValue: false
    name: createCustomLoggingPattern
    inputType: checkbox
    dataType: boolean
    required: true
  - label: Console Logging Pattern
    description:  Pattern used to create log messages to the configured console.
    defaultValue: "%clr(%d{${LOG_DATEFORMAT_PATTERN}}) ${PID: } %clr(${LOG_LEVEL_PATTERN:%5p}) %clr(---) %clr([%15.15t]) %clr(%-40.40logger{39}) %clr(:) %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}}"
    name: consoleLoggingPattern
    inputType: text
    dataType: string
    required: true 
    dependsOn: 
      name: createCustomLoggingPattern

  imports:
  - name: java-version

engine:
  chain:
  - merge:
    - include: [ "**/*" ]
      exclude: [ "config/*.yaml", "Tiltfile", "README.md", "grype.yaml", "catalog/*.yaml", ".github/workflows/**" ]
    - include: [ "config/*.yaml", "Tiltfile" ]
      let:
      - name: repositoryPrefix
        expression: "'dev.local'"
      chain:
      - type: ReplaceText
        substitutions:
        - text: tanzu-java-web-app
          with: "#artifactId"
      - type: ReplaceText
        substitutions:
        - text: your-registry.io/project
          with: "#repositoryPrefix"
    - include: [ "README.md" ]
      chain:
      - type: ReplaceText
        substitutions:
        - text: tanzu-java-web-app
          with: "#artifactId"
    - include: [ "config/workload.yaml" ]
      chain:
      - type: ReplaceText
        substitutions:
        - text: "<INSTANCES>"
          with: "#instances"
    - include: [ "catalog/*.yaml" ]
      chain:
      - type: ReplaceText
        substitutions:
        - text: tanzu-java-web-app
          with: "#artifactId"
      - type: RewritePath
        rewriteTo: "#filename"
    - include: [ "src/main/resources/application.yml" ]
      chain:
      - type: ReplaceText
        substitutions:
        - text: <CONSOLE_LOGGING_PATTERN>
          with: "#consoleLoggingPattern"
  - merge:
    - include: [ "**" ]
    - type: InvokeFragment
      reference: java-version
